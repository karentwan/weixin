<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="author" content="izayl@163.com">
	<title>U趣机器人创客俱乐部会员管理</title>
	
	<link href="http://g.alicdn.com/sj/dpl/1.5.1/css/sui.min.css" rel="stylesheet">
	<script type="text/javascript" src="http://g.alicdn.com/sj/lib/jquery/dist/jquery.min.js"></script>
	<script type="text/javascript" src="http://g.alicdn.com/sj/dpl/1.5.1/js/sui.min.js"></script>

	<style>
		body{background-color: #f2f2f2;}
		.center{
			width:400px;
			text-align: left;
			margin: 2em auto;
			border: 1px #eee solid;
			padding-top: 2em;
			background-color: #fff;
			border-radius: 5px;
			box-shadow: 2px 0px 5px 5px rgba(40,20,20,.5);
		}
		.input-control{height: 50px;}
		.input-control input{padding-left: 2em;}
	</style>
</head>
<body>
	<div class="sui-navbar navbar-inverse">
	  <div class="navbar-inner"><a href="#" class="sui-brand">U趣机器人创客俱乐部会员管理</a>
	    <ul class="sui-nav">
	      <li class="active"><a href="#">会员消费</a></li>
	      <li><a href="/uweixin/admin/topup.html">会员充值</a></li>
	      <li class="sui-dropdown"><a href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">其他 <i class="caret"></i></a>
	        <ul role="menu" class="sui-dropdown-menu">
	          <li role="presentation"><a role="menuitem" tabindex="-1" href="#">待开发</a></li>
	          <li role="presentation"><a role="menuitem" tabindex="-1" href="#">待开发</a></li>
	          <li role="presentation"><a role="menuitem" tabindex="-1" href="#">待开发</a></li>
	        </ul>
	      </li>
	    </ul>
	    <div class="pull-right">
	    	<button class="sui-btn btn-info btn-xlarge">登录</button>
	    </div>
	    <form class="sui-form sui-form">
	      <input type="text" placeholder="会员ID...">
	      <button class="sui-btn">搜索</button>
	    </form>
	  </div>
	</div>
	<ul class="sui-breadcrumb">
	  <li><a href="#">首页</a></li>
	  <li class="active">会员消费</li>
	</ul>
	<div class="msg" style="height:100px;">
		<div class="sui-msg msg-large msg-block msg-success" style="width:400px;margin:0 auto;display:none" id="success">
		  <div class="msg-con">
			消费录入成功
		  </div>
		  <s class="msg-icon"></s>
		</div>
		<div class="sui-msg msg-large msg-block msg-error" style="width:400px;margin:0 auto;display:none" id="error">
		  <div class="msg-con">
			消费录入失败
		  </div>
		  <s class="msg-icon"></s>
		</div>
	</div>
	<h1 style="text-align:center">会员消费录入</h1>
	<form class="sui-form form-horizontal sui-validate center">
	  <div class="control-group">
	    <label for="inputEmail" class="control-label">会员号：</label>
	    <div class="controls">
	      <input class="input-xfat" type="text" id="userId" placeholder="VIP Number" data-rules="required|number" name="userId">
	    </div>
	  </div>
	  <div class="control-group">
	    <label for="money" class="control-label">消费数量：</label>
	    <div class="controls">
	      <input class="input-xfat" type="text" id="money" placeholder="课时数" data-rules="required|number" name="money">
	    </div>
	  </div>
	  <div class="control-group" style="width:49%;margin: 1em auto; margin-left:95px;">
	    <div class="controls">
	      <button id="submit" class="sui-btn btn-block btn-xlarge btn-primary">提交</button>
	    </div>
	  </div>
	</form>

	<script>
		// userId userName 核实
		// 1. get    UserId
		// 2. send   UserId
		// 3. get    UserName
		// 4. render UserName
		var noMatchUserRender = function(){
			var html = 
					'<div class="sui-msg msg-error help-inline">' +
					'	<div class="msg-con">' +
					'		<span>查无此人</span>' +
					'	</div>' +
					'	<i class="msg-icon"></i>' +
					'</div>';
			$("#userId").parent().append($(html));
		};
		var matchUserRender = function(userName){
			var html = 
					'<div class="sui-msg msg-success help-inline">' +
					'	<div class="msg-con">' +
					'		<span>' + userName + '</span>' +
					'	</div>' +
					'	<i class="msg-icon"></i>' +
					'</div>';
			$("#userId").parent().append($(html));
		};
		var matchMsgClearRender = function(){
			$("#userId").parent().find('.sui-msg').remove();
		};
		$("#userId").on("focus",function(){
			$("#userId").parent().find(".sui-msg").remove();
		});
		$("#userId").on('change', function(e){
			var inputId = $(e.target).val();
			console.log("inputId is " + inputId);
			$.ajax({
				url: 'http://weixin2.ngrok.natapp.cn/uweixin/queryName',
				type: 'GET',
				data: {userId: inputId},
				success: function(data){
					console.log("Server response is " + data);
					if (parseInt(data) < 0) {
						console.log("查无此人");
						noMatchUserRender();
					} else {
						console.log(data);
						matchUserRender(JSON.parse(data).userName);
					}
				},
				error: function(){
					alert("连接服务器失败");
				}
			});
			
		});
		// 发送消费情况
		$("form").on("submit",function(e){
			e.preventDefault();
		});

		$("#submit").bind('click', function(){
			$.ajax({
				url: 'http://weixin2.ngrok.natapp.cn/uweixin/consume',
				type: 'GET',
				data: {
					userId: $("#userId").val(),
					money: $("#money").val(), 
					time: (new Date()).getFullYear() + '-' + (new Date()).getMonth() + '-' + (new Date()).getDate()
				},
				success: function(data){
					if (parseInt(data) < 0) {
						matchMsgClearRender();
						$("#error").slideDown(100).fadeOut(2000);
					} else {
						matchMsgClearRender();
						$("#success").slideDown(100).fadeOut(2000);
						$("#userId").val("");
						$("#money").val("");
					}
				},
				error: function(){
					alert("网络连接失败！");
				}
			});
			return false;
		});
	</script>
</body>
</html>